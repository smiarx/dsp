#include <catch2/catch_test_macros.hpp>
#include <catch2/matchers/catch_matchers.hpp>
#include <catch2/matchers/catch_matchers_floating_point.hpp>

#include "dsp/Windows.h"

template <class Win, size_t N>
static void testWin(std::array<double, N> &expect)
{
    constexpr auto kN = sizeof(expect) / sizeof(expect[0]);
    for (size_t n = 0; n < kN; ++n) {
        auto mid = (kN - 1) / 2.;
        auto x   = ((double)n - mid) / (mid);
        REQUIRE_THAT(Win::generate(x),
                     Catch::Matchers::WithinRel(expect[n], 1e-5));
    }
}

TEST_CASE("Windows", "[dsp][window]")
{
    SECTION("Kaiser")
    {
        // att = 140
        // beta = 0.1102 * (att - 8.7)
        // scipy.signal.windows.kaiser(51, beta)
        std::array<double, 51> expect = {
            4.91474830e-06, 5.80696101e-05, 2.44918509e-04, 7.36446405e-04,
            1.82790329e-03, 3.98227650e-03, 7.86942118e-03, 1.43913974e-02,
            2.46834427e-02, 4.00806280e-02, 6.20429860e-02, 9.20367778e-02,
            1.31376184e-01, 1.81037201e-01, 2.41462718e-01, 3.12383274e-01,
            3.92680584e-01, 4.80319601e-01, 5.72369372e-01, 6.65123451e-01,
            7.54318386e-01, 8.35435338e-01, 9.04057360e-01, 9.56245247e-01,
            9.88889915e-01, 1.00000000e+00, 9.88889915e-01, 9.56245247e-01,
            9.04057360e-01, 8.35435338e-01, 7.54318386e-01, 6.65123451e-01,
            5.72369372e-01, 4.80319601e-01, 3.92680584e-01, 3.12383274e-01,
            2.41462718e-01, 1.81037201e-01, 1.31376184e-01, 9.20367778e-02,
            6.20429860e-02, 4.00806280e-02, 2.46834427e-02, 1.43913974e-02,
            7.86942118e-03, 3.98227650e-03, 1.82790329e-03, 7.36446405e-04,
            2.44918509e-04, 5.80696101e-05, 4.91474830e-06};

        testWin<dsp::windows::Kaiser<140>>(expect);
    }
    SECTION("Hamming")
    {
        // scipy.signal.windows.hamming(51)
        std::array<double, 51> expect = {
            0.08,       0.08362724, 0.09445175, 0.11230282, 0.13689893,
            0.16785218, 0.20467443, 0.24678496, 0.29351967, 0.34414153,
            0.39785218, 0.4538046,  0.51111636, 0.56888364, 0.6261954,
            0.68214782, 0.73585847, 0.78648033, 0.83321504, 0.87532557,
            0.91214782, 0.94310107, 0.96769718, 0.98554825, 0.99637276,
            1.,         0.99637276, 0.98554825, 0.96769718, 0.94310107,
            0.91214782, 0.87532557, 0.83321504, 0.78648033, 0.73585847,
            0.68214782, 0.6261954,  0.56888364, 0.51111636, 0.4538046,
            0.39785218, 0.34414153, 0.29351967, 0.24678496, 0.20467443,
            0.16785218, 0.13689893, 0.11230282, 0.09445175, 0.08362724,
            0.08};

        testWin<dsp::windows::Hamming>(expect);
    }
    SECTION("Hanning")
    {
        // scipy.signal.windows.hann(51)
        std::array<double, 51> expect = {
            0.,        0.00394265, 0.01570842, 0.03511176, 0.06184666,
            0.0954915, 0.13551569, 0.18128801, 0.2320866,  0.28711035,
            0.3454915, 0.40630934, 0.46860474, 0.53139526, 0.59369066,
            0.6545085, 0.71288965, 0.7679134,  0.81871199, 0.86448431,
            0.9045085, 0.93815334, 0.96488824, 0.98429158, 0.99605735,
            1.,        0.99605735, 0.98429158, 0.96488824, 0.93815334,
            0.9045085, 0.86448431, 0.81871199, 0.7679134,  0.71288965,
            0.6545085, 0.59369066, 0.53139526, 0.46860474, 0.40630934,
            0.3454915, 0.28711035, 0.2320866,  0.18128801, 0.13551569,
            0.0954915, 0.06184666, 0.03511176, 0.01570842, 0.00394265,
            0.};

        testWin<dsp::windows::Hann>(expect);
    }
}
