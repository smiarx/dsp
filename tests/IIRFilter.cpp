#include <catch2/catch_test_macros.hpp>
#include <catch2/matchers/catch_matchers.hpp>
#include <catch2/matchers/catch_matchers_floating_point.hpp>
#include <iostream>

#include "dsp/IIRFilter.h"

using namespace Catch::Matchers;

TEST_CASE("IIR Filter")
{
    constexpr auto kN = 30;
    SECTION("double")
    {
        dsp::IIRFilter<double, 4> filter;
        decltype(filter)::State state;

        std::array<double, kN> expect;

        // python scipy:
        // x = np.zeros(30);
        // x[0] = 1;
        SECTION("Low pass")
        {
            filter.butterworthLP(0.04);
            // python scipy:
            // signal.sosfilt(signal.butter(4, 0.04, 'lp', output='sos'), x)
            expect = {
                1.32937289e-05, 1.01985887e-04, 3.86854324e-04, 9.98157699e-04,
                2.02589566e-03, 3.51188299e-03, 5.45917297e-03, 7.84042669e-03,
                1.06052910e-02, 1.36868471e-02, 1.70071925e-02, 2.04822159e-02,
                2.40256284e-02, 2.75523081e-02, 3.09810191e-02, 3.42365606e-02,
                3.72514035e-02, 3.99668676e-02, 4.23338923e-02, 4.43134511e-02,
                4.58766570e-02, 4.70046048e-02, 4.76879929e-02, 4.79265639e-02,
                4.77284029e-02, 4.71091246e-02, 4.60909839e-02, 4.47019351e-02,
                4.29746677e-02, 4.09456384e-02,
            };
        }
        SECTION("High pass")
        {
            filter.butterworthHP(0.421);
            // python scipy:
            // signal.sosfilt(signal.butter(4, 0.421, 'hp', output='sos'), x)
            expect = {1.49267352e-01,  -5.04891597e-01, 4.93240000e-01,
                      3.45910393e-02,  -2.02453438e-01, -6.48559490e-02,
                      7.51271373e-02,  5.68014364e-02,  -1.43860450e-02,
                      -3.12944909e-02, -4.61876878e-03, 1.27067443e-02,
                      6.67382670e-03,  -3.43857127e-03, -4.29444215e-03,
                      3.87791255e-05,  1.98433102e-03,  6.93304812e-04,
                      -6.62028190e-04, -5.55353849e-04, 1.04746444e-04,
                      2.92351796e-04,  5.67049072e-05,  -1.13820383e-04,
                      -6.68064042e-05, 2.82841610e-05,  4.07888614e-05,
                      1.63921454e-06,  -1.81278942e-05, -7.24837446e-06};
        }
        SECTION("sos transfert function")
        {
            // python scipy:
            // signal.ellip(4, 1, 100, 1, 'lowpass', output='sos', analog=True)
            decltype(filter)::tf sosba = {{
                {{{1.00000000e-05, 0.00000000e+00, 3.78886514e-03},
                  {1.00000000e+00, 6.75607262e-01, 2.81793736e-01}}},
                {{{1.00000000e+00, 0.00000000e+00, 6.54222638e+01},
                  {1.00000000e+00, 2.76709389e-01, 9.86968702e-01}}},
            }};

            filter.tfAnalog(sosba, 0.1282);
            // python scipy:
            // signal.sosfilt(signal.ellip(4, 1, 100, 0.1282, 'lowpass',
            // output='sos'),x)
            expect = {
                0.00049581,  0.0030516,   0.01006808,  0.02343269,  0.04321694,
                0.06740613,  0.09261813,  0.11494201,  0.13075341,  0.13738352,
                0.13355478,  0.11954173,  0.09706157,  0.06894016,  0.03862821,
                0.0096579,   -0.01487042, -0.03269526, -0.04264255, -0.04469269,
                -0.03987302, -0.03000801, -0.01737806, -0.00434623, 0.00698878,
                0.01506471,  0.01902039,  0.01873967,  0.01478071,  0.00821302,
            };
        }

        for (int i = 0; i < kN; ++i) {
            double x = i == 0 ? 1.f : 0.f;
            filter.process(dsp::Context(&x), state);

            REQUIRE_THAT(x, WithinAbs(expect[i], 1e-8));
        }
    }

    SECTION("floatx4")
    {
        using ft = dsp::mfloat<4>;
        dsp::IIRFilter<ft, 8> filter;
        decltype(filter)::State state;

        std::array<std::array<float, kN>, 4> expect;

        // python scipy:
        // x = np.zeros(30);
        // x[0] = 1;
        SECTION("Low pass")
        {
            filter.butterworthLP({0.01, 0.1, 0.2, 0.543});
            // python scipy:
            // signal.sosfilt(signal.butter(8, 0.01, 'lp', output='sos'), x)
            // signal.sosfilt(signal.butter(8, 0.1, 'lp', output='sos'), x)
            // signal.sosfilt(signal.butter(8, 0.2, 'lp', output='sos'), x)
            // signal.sosfilt(signal.butter(8, 0.543, 'lp', output='sos'), x)
            expect = {{
                {3.42196142e-15, 5.42003373e-14, 4.28687754e-13, 2.27520589e-12,
                 9.18442586e-12, 3.02816626e-11, 8.54203196e-11, 2.12969053e-10,
                 4.80580001e-10, 9.99225854e-10, 1.94070313e-09, 3.55871722e-09,
                 6.21359114e-09, 1.04005739e-08, 1.67816657e-08, 2.62208250e-08,
                 3.98223774e-08, 5.89724053e-08, 8.53828655e-08, 1.21138150e-07,
                 1.68743783e-07, 2.31176930e-07, 3.11938374e-07, 4.15105601e-07,
                 5.45386648e-07, 7.08174327e-07, 9.09600478e-07, 1.15658987e-06,
                 1.45691338e-06, 1.81924014e-06},
                {1.76255373e-07,  2.53637907e-06,  1.79708810e-05,
                 8.41966638e-05,  2.95651965e-04,  8.35883998e-04,
                 1.99456987e-03,  4.15292802e-03,  7.73208228e-03,
                 1.31120915e-02,  2.05389501e-02,  3.00405230e-02,
                 4.13703614e-02,  5.39922353e-02,  6.71100742e-02,
                 7.97397433e-02,  9.08122259e-02,  9.92932627e-02,
                 1.04302716e-01,  1.05217772e-01,  1.01747098e-01,
                 9.39675650e-02,  8.23203233e-02,  6.75681532e-02,
                 5.07204613e-02,  3.29355866e-02,  1.54119646e-02,
                 -7.19893876e-04, -1.44936105e-02, -2.51824008e-02},
                {2.39596441e-05,  3.06312427e-04,  1.88616694e-03,
                 7.48913018e-03,  2.16635509e-02,  4.88858667e-02,
                 8.98799822e-02,  1.38539632e-01,  1.82189269e-01,
                 2.05879884e-01,  1.98744514e-01,  1.59133969e-01,
                 9.59557597e-02,  2.56404112e-02,  -3.37819311e-02,
                 -6.88885797e-02, -7.49082233e-02, -5.63076407e-02,
                 -2.41262297e-02, 8.54945899e-03,  3.11087404e-02,
                 3.83715551e-02,  3.12239291e-02,  1.51236932e-02,
                 -2.62968346e-03, -1.57058344e-02, -2.06691625e-02,
                 -1.75415681e-02, -9.08263071e-03, 7.10955412e-04},
                {1.55692780e-02,  1.13909125e-01,  3.38600744e-01,
                 4.89671500e-01,  2.64798029e-01,  -1.48255982e-01,
                 -1.98620547e-01, 7.82492793e-02,  1.29975876e-01,
                 -6.38173951e-02, -7.92796631e-02, 5.63872584e-02,
                 4.32850205e-02,  -4.69187043e-02, -1.95391915e-02,
                 3.59932911e-02,  5.35991702e-03,  -2.55501305e-02,
                 2.06532091e-03,  1.68219814e-02,  -5.17326448e-03,
                 -1.02121945e-02, 5.79788852e-03,  5.59792372e-03,
                 -5.18225174e-03, -2.61551928e-03, 4.09358122e-03,
                 8.44404135e-04,  -2.95793030e-03, 9.67642564e-05},
            }};
        }
        SECTION("sos transfert function")
        {
            // python scipy:
            // signal.cheby1(10,2,1,analog=True,output='sos')
            decltype(filter)::tf sosba = {
                {{{{0., 0., 0.01021531}, {1., 0.26637237, 0.05650064}}},
                 {{{0., 0., 1.}, {1., 0.22581959, 0.32709869}}},
                 {{{0., 0., 1.}, {1., 0.15088783, 0.70978212}}},
                 {{{0., 0., 1.}, {1., 0.05298476, 0.98038017}}}}};

            filter.tfAnalog(sosba, {0.232, 0.1291, 0.348, 0.0123});
            // python scipy:
            // signal.sosfilt(signal.ellip(4, 1, 100, 0.1282, 'lowpass',
            // output='sos'),x)
            expect = {{{2.69647025e-06,  3.90633161e-05,  2.76906564e-04,
                        1.28619284e-03,  4.42149346e-03,  1.20373096e-02,
                        2.70866812e-02,  5.18342254e-02,  8.59671891e-02,
                        1.25003497e-01,  1.60129079e-01,  1.80171612e-01,
                        1.75431984e-01,  1.42009402e-01,  8.46687629e-02,
                        1.66184707e-02,  -4.42350190e-02, -8.14078254e-02,
                        -8.59650545e-02, -6.00539315e-02, -1.61974697e-02,
                        2.75328808e-02,  5.45505412e-02,  5.60776574e-02,
                        3.41213534e-02,  -8.38866532e-05, -3.13761686e-02,
                        -4.73083503e-02, -4.32170085e-02, -2.35972404e-02},
                       {2.60777212e-08, 4.01537537e-07,  3.06823957e-06,
                        1.56202364e-05, 6.00021710e-05,  1.86619206e-04,
                        4.91980989e-04, 1.13511172e-03,  2.34610196e-03,
                        4.42012901e-03, 7.69221210e-03,  1.24915924e-02,
                        1.90792417e-02, 2.75766550e-02,  3.78977583e-02,
                        4.96975664e-02, 6.23505928e-02,  7.49687956e-02,
                        8.64633864e-02, 9.56479217e-02,  1.01372839e-01,
                        1.02675242e-01, 9.89234311e-02,  8.99343618e-02,
                        7.60442032e-02, 5.81175493e-02,  3.74887651e-02,
                        1.58384536e-02, -4.98235591e-03, -2.31594512e-02},
                       {6.82271777e-05,  8.90602840e-04,  5.54178690e-03,
                        2.18689139e-02,  6.12982502e-02,  1.29102965e-01,
                        2.09578578e-01,  2.61826473e-01,  2.40606393e-01,
                        1.34375856e-01,  -1.17852214e-02, -1.17281846e-01,
                        -1.23364527e-01, -4.09494680e-02, 5.57793262e-02,
                        8.91097307e-02,  4.04797969e-02,  -3.91609374e-02,
                        -7.93972216e-02, -5.35399735e-02, 2.82185534e-03,
                        3.16728081e-02,  9.34191736e-03,  -3.44864859e-02,
                        -5.05500475e-02, -2.00237790e-02, 2.87568192e-02,
                        5.05938579e-02,  2.79099583e-02,  -1.46431973e-02},
                       {1.95757826e-16, 3.12627667e-15, 2.49570837e-14,
                        1.33824494e-13, 5.46302241e-13, 1.82299314e-12,
                        5.20830345e-12, 1.31593320e-11, 3.01071521e-11,
                        6.34917999e-11, 1.25110212e-10, 2.32814189e-10,
                        4.12593198e-10, 7.01074481e-10, 1.14847051e-09,
                        1.82200133e-09, 2.80981676e-09, 4.22544073e-09,
                        6.21275760e-09, 8.95155708e-09, 1.26636522e-08,
                        1.76195816e-08, 2.41459045e-08, 3.26330939e-08,
                        4.35440320e-08, 5.74231055e-08, 7.49059002e-08,
                        9.67294880e-08, 1.23743297e-07, 1.56920554e-07}}};
        }

        for (int i = 0; i < kN; ++i) {
            ft x = i == 0 ? 1.f : 0.f;
            filter.process(dsp::Context(&x), state);

            for (int j = 0; j < 4; ++j) {
                REQUIRE_THAT(x[j], WithinAbs(expect[j][i], 1e-5f));
            }
        }
    }
}
