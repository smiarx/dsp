#include "dsp/LinearAlgebra.h"
#include "dsp/simd/multi.h"
#include <catch2/catch_test_macros.hpp>
#include <catch2/generators/catch_generators.hpp>
#include <catch2/generators/catch_generators_adapters.hpp>
#include <catch2/generators/catch_generators_random.hpp>
#include <catch2/matchers/catch_matchers.hpp>
#include <catch2/matchers/catch_matchers_floating_point.hpp>

TEST_CASE("Linear Algebra", "[dsp][linalg]")
{
    using namespace Catch::Matchers;

    SECTION("Vector")
    {
        constexpr auto kN = 9;
        float data1[]     = {
            0.19994948436591342,  0.7874002272106683, 0.4864291127437427,
            0.007528235860332022, 0.2042149590580502, 0.11804062532670545,
            0.74453976903092,     0.3618258778718607, 0.26765807245773077,
        };
        float data2[] = {
            0.5730070982631973, 0.432949759455725,  0.16472577880433537,
            0.8769356833314177, 0.6041775408980659, 0.6952165080563191,
            0.5722165484961537, 0.8647299394173802, 0.763823807731335,
        };
        float data3[] = {
            1.174677812944249,    -0.4544198035390498, -0.4431667769288161,
            1.1306128543199672,   1.0569684260136543,  -0.23213864834621403,
            -0.39157441913762203, 0.1108208765866104,  -0.5525866596092587,
        };

        dsp::linalg::Vector<float, kN> v1(data1);
        dsp::linalg::Vector<float, kN> v2(data2);
        dsp::linalg::Vector<float, kN> v3(data3);
        dsp::linalg::Vector<float, kN> vres{};

        SECTION("dot")
        {
            float expect = 1.6910155433964247;
            REQUIRE_THAT(v1.dot(v2), WithinAbs(expect, 1e-6f));
        }

        SECTION("add")
        {
            float expect[] = {
                0.7729565826291107, 1.2203499866663932, 0.651154891548078,
                0.8844639191917497, 0.8083924999561161, 0.8132571333830245,
                1.3167563175270738, 1.226555817289241,  1.0314818801890657,
            };
            vres = v1 + v2;
            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(vres[i], WithinAbs(expect[i], 1e-6f));
        }

        SECTION("sub")
        {
            float expect[] = {
                0.6016707146810517,  -0.8873695629947749, -0.6078925557331515,
                0.25367717098854947, 0.4527908851155884,  -0.9273551564025331,
                -0.9637909676337757, -0.7539090628307697, -1.3164104673405936,
            };
            vres = v3 - v2;
            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(vres[i], WithinAbs(expect[i], 1e-6f));
        }

        SECTION("product")
        {
            float expect[] = {
                0.23487622299428149,  -0.35781025655567505,
                -0.21556922209898816, 0.008511520234043921,
                0.21584876384403018,  -0.02740179121328328,
                -0.29154272758314176, 0.04009786095747944,
                -0.14790428017687038,
            };
            vres = v3 * v1;
            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(vres[i], WithinAbs(expect[i], 1e-6f));
        }

        SECTION("div")
        {
            float expect[] = {
                2.8657593195618225, 0.5498471355405002, 0.3386429275895645,
                116.48621265337742, 2.95853713990816,   5.889637623759976,
                0.768550683653797,  2.3899062844908543, 2.8537297631924026,
            };
            vres = v2 / v1;
            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(vres[i], WithinAbs(expect[i], 1e-6f));
        }

        SECTION("example")
        {
            float expect = 0.11071771273802711;
            auto res     = v3.dot(v1 + v2 * 0.493f);
            REQUIRE_THAT(res, WithinAbs(expect, 1e-6f));
        }
    }

    // Matrix
    SECTION("Matrix")
    {
        SECTION("[9,9]x[9] matrix multiplication")
        {
            constexpr auto kH = 9, kW = 9;
            float mdata[] = {
                -0.0201227, 0.827849,    -0.993496,  0.517801,  0.229335,
                0.155655,   1.1435,      -0.185755,  -2.40023, //
                -1.48645,   -0.00743704, 0.753557,   -0.676103, 0.0736444,
                0.354349,   -0.161246,   -0.414218,  -0.56778, //
                1.00586,    0.393408,    0.47929,    0.279408,  0.634931,
                0.239053,   0.620365,    0.182712,   -0.786358, //
                0.817327,   0.53564,     0.393489,   -0.85824,  -1.20803,
                0.832489,   -0.372284,   -0.988143,  1.51579, //
                -0.579228,  1.82557,     0.151341,   -0.914847, 1.42405,
                -1.38774,   -1.24858,    -0.590184,  0.069131, //
                0.679011,   -2.31887,    -0.0997849, 1.30914,   0.915894,
                1.20124,    -0.16385,    -2.39871,   0.770679, //
                1.0603,     -0.711255,   0.296293,   0.466877,  -0.326129,
                -0.313659,  0.721098,    0.0981066,  1.5753, //
                -0.0596541, -0.32597,    -1.41739,   0.0303329, 0.746495,
                -0.302158,  -0.641261,   0.56958,    -1.66368, //
                0.908111,   -1.06991,    0.343594,   0.368101,  1.67587,
                0.0497467,  1.27924,     1.30278,    0.986297, //
            };
            float vdata[] = {
                0.025809048154903848, 0.07019922600038765, 1.5715339069446175,
                -0.2692756172391693,  0.4536383534075804,  0.5156753474112498,
                -0.2937506221713975,  0.20756763622341534, 0.28073929265193776,
            };

            dsp::linalg::Matrix<float, kH, kW> m(mdata);
            dsp::linalg::Vector<float, kW> v(vdata);
            dsp::linalg::Vector<float, kH> res;

            res = m.mul(v);

            float expect[] = {
                -2.5071439456574103, 1.345538573267296,   0.7777931673597447,
                1.1192614680568829,  0.7914434688797075,  0.14693791162197756,
                0.2584517059291474,  -2.2377104947427293, 1.3466030570463032,
            };

            for (int i = 0; i < kW; ++i)
                REQUIRE_THAT(res[i], WithinAbs(expect[i], 1e-4f));
        }

        SECTION("[13,7]x[7] matrix multiplication")
        {
            constexpr auto kH = 13, kW = 7;
            float mdata[] = {
                -0.222568,   0.855253,   -0.206352,  -0.409591,
                0.750681,    -0.296334,  0.956, //
                0.526636,    -0.523251,  -0.352669,  -0.390528,
                -1.70954,    -0.015496,  0.71654, //
                -0.437929,   -1.2877,    1.26909,    -1.06393,
                0.92226,     -0.176865,  -0.581722, //
                0.322891,    -0.372106,  0.220762,   0.956861,
                1.0181,      1.1018,     -0.0152788, //
                -0.12738,    2.04705,    -1.12211,   -0.378109,
                -0.790379,   0.692755,   0.500099, //
                0.0865845,   -0.964603,  -0.296842,  0.897154,
                1.05676,     2.30892,    -0.838756, //
                0.318239,    1.06267,    -2.12273,   -0.789655,
                -0.190676,   1.13149,    -1.04213, //
                1.0709,      -0.807204,  0.597374,   -1.10611,
                -0.391786,   0.459716,   0.429265, //
                -0.271101,   0.144333,   0.256038,   -2.36134,
                -1.38853,    -0.858348,  -1.29348, //
                0.229607,    -0.127949,  -2.10308,   -0.674383,
                0.97434,     1.27154,    -0.725723, //
                0.2544,      2.45716,    -0.603385,  -0.799055,
                -0.285223,   -0.0807289, -1.7702, //
                -0.557625,   1.4889,     2.49671,    -0.100197,
                -1.89941,    0.0818771,  0.470817, //
                -0.00471054, 0.735066,   0.0366381,  -0.15587,
                -0.910188,   0.974196,   0.557412, //
            };
            float vdata[] = {
                1.2609308140222666,  -1.09960454844304,   -1.6608439256016139,
                1.0635245388564434,  -0.8584114360665228, -0.024608700789958592,
                -0.3711470023650308,
            };

            dsp::linalg::Matrix<float, kH, kW> m(mdata);
            dsp::linalg::Vector<float, kW> v(vdata);
            dsp::linalg::Vector<float, kH> res;

            res = m.mul(v);

            float expect[] = {
                -2.305891340330326,  2.611738868527683,    -2.9469339778916708,
                0.5719160834967264,  -0.47422297051932816, 1.9643606104334546,
                2.4410763930820494,  0.23510069511005346,  -1.7440105291402264,
                2.6075451198532837,  -1.3249788886008802,  -5.139818724427391,
                -0.4903829130510562,
            };

            for (int i = 0; i < kW; ++i)
                REQUIRE_THAT(res[i], WithinAbs(expect[i], 1e-4f));
        }
    }
}
