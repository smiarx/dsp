#include "dsp/LinearAlgebra.h"
#include "dsp/simd/multi.h"
#include <catch2/catch_test_macros.hpp>
#include <catch2/generators/catch_generators.hpp>
#include <catch2/generators/catch_generators_adapters.hpp>
#include <catch2/generators/catch_generators_random.hpp>
#include <catch2/matchers/catch_matchers.hpp>
#include <catch2/matchers/catch_matchers_floating_point.hpp>

TEST_CASE("Linear Algebra", "[dsp][linalg]")
{
    using namespace Catch::Matchers;

    SECTION("Vector")
    {
        constexpr auto kN = 9;
        float data1[]     = {
            0.19994948436591342,  0.7874002272106683, 0.4864291127437427,
            0.007528235860332022, 0.2042149590580502, 0.11804062532670545,
            0.74453976903092,     0.3618258778718607, 0.26765807245773077,
        };
        float data2[] = {
            0.5730070982631973, 0.432949759455725,  0.16472577880433537,
            0.8769356833314177, 0.6041775408980659, 0.6952165080563191,
            0.5722165484961537, 0.8647299394173802, 0.763823807731335,
        };
        float data3[] = {
            1.174677812944249,    -0.4544198035390498, -0.4431667769288161,
            1.1306128543199672,   1.0569684260136543,  -0.23213864834621403,
            -0.39157441913762203, 0.1108208765866104,  -0.5525866596092587,
        };

        dsp::linalg::Vector<float, kN> v1(data1);
        dsp::linalg::Vector<float, kN> v2(data2);
        dsp::linalg::Vector<float, kN> v3(data3);
        dsp::linalg::Vector<float, kN> vres{};

        SECTION("dot")
        {
            float expect = 1.6910155433964247;
            REQUIRE_THAT(v1.dot(v2), WithinAbs(expect, 1e-6f));
        }

        SECTION("add")
        {
            float expect[] = {
                0.7729565826291107, 1.2203499866663932, 0.651154891548078,
                0.8844639191917497, 0.8083924999561161, 0.8132571333830245,
                1.3167563175270738, 1.226555817289241,  1.0314818801890657,
            };
            vres = v1 + v2;
            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(vres[i], WithinAbs(expect[i], 1e-6f));
        }

        SECTION("sub")
        {
            float expect[] = {
                0.6016707146810517,  -0.8873695629947749, -0.6078925557331515,
                0.25367717098854947, 0.4527908851155884,  -0.9273551564025331,
                -0.9637909676337757, -0.7539090628307697, -1.3164104673405936,
            };
            vres = v3 - v2;
            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(vres[i], WithinAbs(expect[i], 1e-6f));
        }

        SECTION("product")
        {
            float expect[] = {
                0.23487622299428149,  -0.35781025655567505,
                -0.21556922209898816, 0.008511520234043921,
                0.21584876384403018,  -0.02740179121328328,
                -0.29154272758314176, 0.04009786095747944,
                -0.14790428017687038,
            };
            vres = v3 * v1;
            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(vres[i], WithinAbs(expect[i], 1e-6f));
        }

        SECTION("div")
        {
            float expect[] = {
                2.8657593195618225, 0.5498471355405002, 0.3386429275895645,
                116.48621265337742, 2.95853713990816,   5.889637623759976,
                0.768550683653797,  2.3899062844908543, 2.8537297631924026,
            };
            vres = v2 / v1;
            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(vres[i], WithinAbs(expect[i], 1e-6f));
        }

        SECTION("example")
        {
            float expect = 0.11071771273802711;
            auto res     = v3.dot(v1 + v2 * 0.493f);
            REQUIRE_THAT(res, WithinAbs(expect, 1e-6f));
        }
    }

    // Matrix
    SECTION("Matrix")
    {
        SECTION("[9,9]x[9] matrix multiplication")
        {
            constexpr auto kH = 9, kW = 9;
            float mdata[] = {
                -0.0201227, 0.827849,    -0.993496,  0.517801,  0.229335,
                0.155655,   1.1435,      -0.185755,  -2.40023, //
                -1.48645,   -0.00743704, 0.753557,   -0.676103, 0.0736444,
                0.354349,   -0.161246,   -0.414218,  -0.56778, //
                1.00586,    0.393408,    0.47929,    0.279408,  0.634931,
                0.239053,   0.620365,    0.182712,   -0.786358, //
                0.817327,   0.53564,     0.393489,   -0.85824,  -1.20803,
                0.832489,   -0.372284,   -0.988143,  1.51579, //
                -0.579228,  1.82557,     0.151341,   -0.914847, 1.42405,
                -1.38774,   -1.24858,    -0.590184,  0.069131, //
                0.679011,   -2.31887,    -0.0997849, 1.30914,   0.915894,
                1.20124,    -0.16385,    -2.39871,   0.770679, //
                1.0603,     -0.711255,   0.296293,   0.466877,  -0.326129,
                -0.313659,  0.721098,    0.0981066,  1.5753, //
                -0.0596541, -0.32597,    -1.41739,   0.0303329, 0.746495,
                -0.302158,  -0.641261,   0.56958,    -1.66368, //
                0.908111,   -1.06991,    0.343594,   0.368101,  1.67587,
                0.0497467,  1.27924,     1.30278,    0.986297, //
            };
            float vdata[] = {
                0.025809048154903848, 0.07019922600038765, 1.5715339069446175,
                -0.2692756172391693,  0.4536383534075804,  0.5156753474112498,
                -0.2937506221713975,  0.20756763622341534, 0.28073929265193776,
            };

            dsp::linalg::Matrix<float, kH, kW> m(mdata);
            dsp::linalg::Vector<float, kW> v(vdata);
            dsp::linalg::Vector<float, kH> res;

            res = m.mul(v);

            float expect[] = {
                -2.5071439456574103, 1.345538573267296,   0.7777931673597447,
                1.1192614680568829,  0.7914434688797075,  0.14693791162197756,
                0.2584517059291474,  -2.2377104947427293, 1.3466030570463032,
            };

            for (int i = 0; i < kH; ++i)
                REQUIRE_THAT(res[i], WithinAbs(expect[i], 1e-4f));
        }

        SECTION("[13,7]x[7] matrix multiplication")
        {
            constexpr auto kH = 13, kW = 7;
            float mdata[] = {
                -0.222568,   0.855253,   -0.206352,  -0.409591,
                0.750681,    -0.296334,  0.956, //
                0.526636,    -0.523251,  -0.352669,  -0.390528,
                -1.70954,    -0.015496,  0.71654, //
                -0.437929,   -1.2877,    1.26909,    -1.06393,
                0.92226,     -0.176865,  -0.581722, //
                0.322891,    -0.372106,  0.220762,   0.956861,
                1.0181,      1.1018,     -0.0152788, //
                -0.12738,    2.04705,    -1.12211,   -0.378109,
                -0.790379,   0.692755,   0.500099, //
                0.0865845,   -0.964603,  -0.296842,  0.897154,
                1.05676,     2.30892,    -0.838756, //
                0.318239,    1.06267,    -2.12273,   -0.789655,
                -0.190676,   1.13149,    -1.04213, //
                1.0709,      -0.807204,  0.597374,   -1.10611,
                -0.391786,   0.459716,   0.429265, //
                -0.271101,   0.144333,   0.256038,   -2.36134,
                -1.38853,    -0.858348,  -1.29348, //
                0.229607,    -0.127949,  -2.10308,   -0.674383,
                0.97434,     1.27154,    -0.725723, //
                0.2544,      2.45716,    -0.603385,  -0.799055,
                -0.285223,   -0.0807289, -1.7702, //
                -0.557625,   1.4889,     2.49671,    -0.100197,
                -1.89941,    0.0818771,  0.470817, //
                -0.00471054, 0.735066,   0.0366381,  -0.15587,
                -0.910188,   0.974196,   0.557412, //
            };
            float vdata[] = {
                1.2609308140222666,  -1.09960454844304,   -1.6608439256016139,
                1.0635245388564434,  -0.8584114360665228, -0.024608700789958592,
                -0.3711470023650308,
            };

            dsp::linalg::Matrix<float, kH, kW> m(mdata);
            dsp::linalg::Vector<float, kW> v(vdata);
            dsp::linalg::Vector<float, kH> res;

            res = m.mul(v);

            float expect[] = {
                -2.305891340330326,  2.611738868527683,    -2.9469339778916708,
                0.5719160834967264,  -0.47422297051932816, 1.9643606104334546,
                2.4410763930820494,  0.23510069511005346,  -1.7440105291402264,
                2.6075451198532837,  -1.3249788886008802,  -5.139818724427391,
                -0.4903829130510562,
            };

            for (int i = 0; i < kH; ++i)
                REQUIRE_THAT(res[i], WithinAbs(expect[i], 1e-4f));
        }

        SECTION("[11,9]x[9,5] matrix multiplication")
        {
            constexpr auto kH = 11, kW = 9, kW2 = 5;
            float m1data[] = {
                -1.50166,  -0.772464,  0.732438,   1.18027,    0.773046,
                -0.392467, 0.522377,   -0.213731,  -0.387996, //
                1.07162,   2.18093,    0.77386,    -0.794678,  -1.3701,
                -0.451034, -0.265108,  -3.14383,   -0.166835, //
                -0.174862, 0.33618,    -1.84457,   0.816871,   -0.140713,
                -0.288212, -0.802689,  1.74998,    -0.987514, //
                -0.315261, -1.62355,   0.639503,   -1.25605,   -1.39186,
                -0.830913, -0.396242,  2.48648,    1.28865, //
                -0.612615, 0.670195,   -0.345672,  3.23655,    1.14946,
                0.338887,  -0.281437,  -0.404541,  -0.289384, //
                2.29452,   -0.0168515, -1.44609,   0.0856618,  -1.23865,
                -0.735792, -2.03022,   -0.881368,  -0.643943, //
                0.180519,  0.203669,   -1.24891,   -0.138446,  -0.871766,
                -0.666417, -0.15298,   -0.0671621, -1.61371, //
                -0.481413, 0.456332,   1.6191,     -0.230217,  1.10845,
                1.85041,   -0.635874,  1.40749,    1.53068, //
                1.71377,   0.939776,   -0.681039,  0.276761,   -0.0765314,
                0.754849,  0.374567,   -1.03238,   0.444399, //
                0.603822,  0.153778,   -0.929434,  -0.0189394, -0.34049,
                -1.88353,  -0.50561,   -1.294,     0.247799, //
                1.58304,   -1.02433,   1.89696,    -1.07552,   1.68124,
                -1.10142,  0.075602,   -1.00066,   -1.37264, //
            };
            float m2data[] = {
                -1.19738,   0.109183, 0.700049,  -1.51582,    -0.971446, //
                -1.26752,   0.317301, -1.56853,  0.877012,    2.36487,   //
                -0.0277601, 1.71523,  0.142743,  0.872356,    -0.546297, //
                0.494616,   0.692099, 0.308695,  -1.01765,    0.716888,  //
                2.55999,    0.306151, -1.40231,  -0.185894,   -0.272663, //
                -0.830182,  0.974624, 1.35362,   -0.00915486, -0.457988, //
                0.0700825,  1.57305,  0.58856,   -0.467388,   -0.301977, //
                -0.0833547, -0.96961, -1.04408,  0.100834,    2.1428,    //
                0.23092,    0.354893, -0.916508, -1.16563,    1.04852,   //
            };

            dsp::linalg::Matrix<float, kH, kW> m1(m1data);
            dsp::linalg::Matrix<float, kW, kW2> m2(m2data);
            dsp::linalg::Matrix<float, kH, kW2> res;

            res = m1.mul(m2);

            float expect[] = {
                5.61025,    2.40953,  -0.0998021, 1.08307,   -0.975585, //
                -7.3901,    3.29937,  1.78456,    2.03229,   -3.12723,  //
                -0.312611,  -6.14483, -2.24815,   -0.149023, 5.68537,   //
                -1.01444,   -4.13483, -1.15383,   0.0902791, 2.77588,   //
                4.10292,    2.3219,   -1.16153,   -1.86756,  3.13522,   //
                -5.42114,   -5.83981, 2.50922,    -2.99393,  -2.69344,  //
                -2.56433,   -3.81826, 1.36537,    1.07026,   -0.357499, //
                1.33224,    3.03107,  -3.18905,   1.20858,   4.16052,   //
                -3.69507,   1.96891,  1.73402,    -3.43919,  -1.05611,  //
                -0.0798142, -2.88528, -1.20278,   -1.67441,  -1.13355,  //
                3.80831,    2.40046,  1.15245,    0.612687,  -9.32784,  //
            };

            for (int i = 0; i < kH; ++i)
                for (int j = 0; j < kW2; ++j)
                    REQUIRE_THAT(res.get(i, j),
                                 WithinAbs(expect[i * kW2 + j], 1e-4f));
        }

        SECTION("outer")
        {
            constexpr auto kH = 15, kW = 10;
            float v1data[] = {
                -0.8879368601068311, -0.20250246002497882,  -0.1122835688431658,
                -2.1351395772219024, 0.9785055293555012,    0.5149327232485791,
                0.09464543132173703, -1.1748006100278603,   -1.2748844862230668,
                1.239660798814364,   -0.09756586876138984,  -0.4372359961390567,
                0.8034892910065845,  -0.033985781511560356, -0.8647465122442803,
            };

            float v2data[] = {
                0.2390909749345621,   -1.0738644401489381, 1.4498239343806605,
                -0.02755200530046823, -0.1827219983232334, 0.7865704259975993,
                0.9777938520436766,   0.6235231030772302,  0.2203058963506213,
                -0.3391677055896273,
            };

            float expect[] = {
                -0.212298,   0.953524,   -1.28735,   0.0244644,   0.162246,
                -0.698425,   -0.868219,  -0.553649,  -0.195618,   0.30116, //
                -0.0484165,  0.21746,    -0.293593,  0.00557935,  0.0370017,
                -0.159282,   -0.198006,  -0.126265,  -0.0446125,  0.0686823, //
                -0.026846,   0.120577,   -0.162791,  0.00309364,  0.0205167,
                -0.0883189,  -0.10979,   -0.0700114, -0.0247367,  0.038083, //
                -0.510493,   2.29285,    -3.09558,   0.0588274,   0.390137,
                -1.67944,    -2.08773,   -1.33131,   -0.470384,   0.72417, //
                0.233952,    -1.05078,   1.41866,    -0.0269598,  -0.178794,
                0.769664,    0.956777,   0.610121,   0.215571,    -0.331877, //
                0.123116,    -0.552968,  0.746562,   -0.0141874,  -0.0940895,
                0.405031,    0.503498,   0.321072,   0.113443,    -0.174649, //
                0.0226289,   -0.101636,  0.137219,   -0.00260767, -0.0172938,
                0.0744453,   0.0925437,  0.0590136,  0.0208509,   -0.0321007, //
                -0.280884,   1.26158,    -1.70325,   0.0323681,   0.214662,
                -0.924063,   -1.14871,   -0.732515,  -0.258816,   0.398454, //
                -0.304813,   1.36905,    -1.84836,   0.0351256,   0.232949,
                -1.00279,    -1.24657,   -0.79492,   -0.280865,   0.4324, //
                0.296392,    -1.33123,   1.79729,    -0.0341551,  -0.226513,
                0.975081,    1.21213,    0.772957,   0.273105,    -0.420453, //
                -0.0233271,  0.104773,   -0.141453,  0.00268814,  0.0178274,
                -0.0767424,  -0.0953993, -0.0608346, -0.0214943,  0.0330912, //
                -0.104539,   0.469532,   -0.633915,  0.0120467,   0.0798926,
                -0.343917,   -0.427527,  -0.272627,  -0.0963257,  0.148296, //
                0.192107,    -0.862839,  1.16492,    -0.0221377,  -0.146815,
                0.632001,    0.785647,   0.500994,   0.177013,    -0.272518, //
                -0.00812569, 0.0364961,  -0.0492734, 0.000936376, 0.00620995,
                -0.0267322,  -0.0332311, -0.0211909, -0.00748727, 0.0115269, //
                -0.206753,   0.928621,   -1.25373,   0.0238255,   0.158008,
                -0.680184,   -0.845544,  -0.539189,  -0.190509,   0.293294, //
            };

            dsp::linalg::Vector<float, kH> v1(v1data);
            dsp::linalg::Vector<float, kW> v2(v2data);

            dsp::linalg::Matrix<float, kH, kW> m;
            m = v1.outer(v2);

            for (int i = 0; i < kH; ++i)
                for (int j = 0; j < kW; ++j)
                    REQUIRE_THAT(m.get(i, j),
                                 WithinAbs(expect[i * kW + j], 1e-4f));
        }
    }

    // Identity
    SECTION("Identity")
    {
        SECTION("mult vector")
        {
            constexpr auto kN = 9;
            float vdata[]     = {
                0.025809048154903848, 0.07019922600038765, 1.5715339069446175,
                -0.2692756172391693,  0.4536383534075804,  0.5156753474112498,
                -0.2937506221713975,  0.20756763622341534, 0.28073929265193776,
            };

            dsp::linalg::Identity<float, kN> id;
            dsp::linalg::Vector<float, kN> v(vdata);
            dsp::linalg::Vector<float, kN> res;

            res = id.mul(v);

            for (int i = 0; i < kN; ++i)
                REQUIRE_THAT(res[i], WithinAbs(vdata[i], 1e-4f));
        }

        SECTION("operations")
        {
            constexpr auto kN = 10;
            float mdata[]     = {
                -0.125019,  0.48522,    0.189876,  -0.073505,   -0.541225,
                -1.00543,   -0.195048,  1.14792,   0.765075,    0.829074, //
                1.22247,    -1.30217,   -0.773995, 1.14665,     0.0473109,
                -0.244878,  -0.156192,  0.827631,  1.30544,     1.74224, //
                -0.0315407, -0.645152,  -0.785071, 0.246253,    1.04653,
                0.509217,   -0.155665,  0.156816,  0.0448288,   0.937661, //
                -0.569781,  0.452466,   -2.04003,  -2.52033,    -0.593666,
                -0.552103,  -1.00388,   -0.84621,  0.454057,    0.45108, //
                -0.193839,  -0.0379306, 0.14633,   1.7777,      0.992641,
                -0.793362,  1.19852,    0.411359,  -1.45623,    -2.4776, //
                -0.522436,  0.715289,   -1.24926,  1.82042,     1.59898,
                1.70839,    1.68923,    -1.47447,  -1.29631,    0.751573, //
                1.07808,    -0.422254,  -1.37369,  0.832004,    -1.09006,
                -2.06758,   -1.18843,   0.0324569, -0.738421,   0.612704, //
                0.73506,    -0.189067,  0.385283,  0.171306,    -0.380081,
                0.905205,   0.726502,   1.21804,   0.0211586,   -0.401942, //
                -0.872775,  -0.0844755, -0.470874, 1.19829,     -0.325992,
                0.246665,   -1.09358,   -0.789237, -0.00449961, -0.336185, //
                1.0521,     -0.161823,  -0.363474, -0.26255,    1.48842,
                0.206788,   1.20077,    -1.48065,  0.0382689,   -1.52018, //
            };

            dsp::linalg::Identity<float, kN> id;
            dsp::linalg::Matrix<float, kN, kN> m(mdata);
            dsp::linalg::Matrix<float, kN, kN> res;

            float op;

            SECTION("add")
            {
                op  = +1;
                res = id + m;
            }
            SECTION("sub")
            {
                op  = -1;
                res = id - m;
            }

            for (int i = 0; i < kN; ++i)
                for (int j = 0; j < kN; ++j)
                    REQUIRE_THAT(
                        res.get(i, j),
                        WithinAbs((i == j ? 1.f : 0.f) + op * mdata[i * kN + j],
                                  1e-4f));
        }
    }
}
